import logging
from telegram.ext import Application, CommandHandler, MessageHandler, filters

from config import load_secrets
from core.ai_services import AIService
from core.vector_db import VectorDBService
from telegram.handlers import start, handle_text_message, handle_voice_message, handle_photo_message

def main() -> None:
    """Starts the bot and wires up all the services."""
    
    # Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù„ÛŒØ¯Ù‡Ø§ Ùˆ ØªÙ†Ø¸ÛŒÙ…Ø§Øª
    secrets = load_secrets()
    if not all(secrets.values()):
        logging.critical("âŒ ÛŒÚ©ÛŒ Ø§Ø² Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ API ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ù†Ø§Ù…Ù‡ Ù…ØªÙˆÙ‚Ù Ø´Ø¯.")
        return
        
    # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
    try:
        ai_service = AIService(api_key=secrets["GOOGLE_API_KEY"])
        db_service = VectorDBService(api_key=secrets["PINECONE_API_KEY"], index_name=secrets["PINECONE_INDEX_NAME"])
    except Exception as e:
        logging.critical(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ: {e}")
        return

    # Ø³Ø§Ø®Øª Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† ØªÙ„Ú¯Ø±Ø§Ù…
    builder = Application.builder().token(secrets["TELEGRAM_BOT_TOKEN"])
    application = builder.build()
    
    # Ø¨Ù‡ Ø§Ø´ØªØ±Ø§Ú©â€ŒÚ¯Ø°Ø§Ø±ÛŒ Ù†Ù…ÙˆÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø±ÙˆÛŒØ³ Ø¨Ø§ context
    application.bot_data["ai_service"] = ai_service
    application.bot_data["db_service"] = db_service
    
    # Ø«Ø¨Øª Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text_message))
    application.add_handler(MessageHandler(filters.VOICE, handle_voice_message))
    application.add_handler(MessageHandler(filters.PHOTO, handle_photo_message))
    
    logging.info("ğŸ”¥ Ø±Ø¨Ø§Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ÙØ¹Ø§Ù„ Ø´Ø¯! Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù….")
    # Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
    application.run_polling()
